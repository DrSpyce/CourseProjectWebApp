@using CourseProjectWebApp.Authorization;
@using Markdig
@using Microsoft.AspNetCore.Authorization
@using CourseProjectWebApp.Models
@using static CourseProjectWebApp.Authorization.ProjectConstans
@inject IAuthorizationService AuthorizationService

@model CourseProjectWebApp.Models.ViewModels.CollectionItemsViewModel

@{
	ViewData["Title"] = "Details";
}

<h1>Details</h1>
@{
	var result = Markdown.ToHtml(Model.Coll.Description);
}
<div>
	<h4>Collection: @Html.DisplayFor(model => model.Coll.Title)</h4>
	<div class="">
		<dl class="row">
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Coll.Topic)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Coll.Topic)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Coll.Description)
			</dt>
			<dd class="col-sm-10 mb-0">
				@Html.Raw(result)
			</dd>
		</dl>
	</div>
	<div>
		<div class="hstack gap-3 mb-2">
			@if ((await AuthorizationService.AuthorizeAsync(User, Model.Coll, CollectionOperations.Update)).Succeeded)
			{
				<a class="btn btn-primary px-4" asp-action="Edit" asp-route-id="@Model.Coll.Id">Edit</a>
			}
			@if ((await AuthorizationService.AuthorizeAsync(User, Model.Coll, CollectionOperations.Delete)).Succeeded)
			{
				@*make alert for deleting collection*@
				<form asp-action="Delete" asp-route-id="@Model.Coll.Id" method="post">
					<button type="submit" class="btn btn-danger px-4">Delete</button>
				</form>
			}
		</div>
	</div>
</div>
<hr />
@if (Model.Items.Count == 0)
{
	<h1 class="fs-3">This Collection is empty</h1>
	@if ((await AuthorizationService.AuthorizeAsync(User, Model.Coll, CollectionOperations.Create)).Succeeded)
	{
		<a asp-controller="Item" asp-action="Create" asp-route-id="@Model.Coll.Id" class="fs-5">Start with creating new one</a>
	}
}
else
{
	@if ((await AuthorizationService.AuthorizeAsync(User, Model.Coll, CollectionOperations.Create)).Succeeded)
	{
		<a asp-controller="Item" asp-action="Create" asp-route-id="@Model.Coll.Id" class="btn-primary btn">Create new Item</a>
	}
	<h2 class="fs-4 mt-2">Here is list of Items:</h2>
	<div class="list-group">
		<table class="table text-center">
			<thead>
				<tr>
					<th>ID</th>
					<th>Title</th>
					<th>Tags?</th>
					@if(Model.AddStr != null)
					{
						foreach(var item in Model.AddStr)
						{
							<th>@item.Name</th>
						}
					}
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				@foreach(var item in Model.Items)
				{
					<tr>
						<td>@item.Id</td>
						<td>@item.Title</td>
						<td>tags?</td>
						@if(item.ItemsAdditionalStrings != null)
						{
							foreach(var itemAddStr in item.ItemsAdditionalStrings)
							{
								<td>@itemAddStr.Data</td>
							}
						}
						<td>
							<div class="d-flex justify-content-center">
								<a asp-controller="item" asp-action="Details" asp-route-id="@Model.Coll.Id" asp-route-itemId="@item.Id" class="btn btn-primary">Show</a>
								@if ((await AuthorizationService.AuthorizeAsync(User, Model.Coll, CollectionOperations.Update)).Succeeded)
								{
									<a asp-controller="Item" asp-action="Edit" asp-route-id="@Model.Coll.Id" asp-route-itemId="@item.Id" class="btn btn-primary ms-1 me-1">Edit</a>

								}
								@if ((await AuthorizationService.AuthorizeAsync(User, Model.Coll, CollectionOperations.Delete)).Succeeded)
								{
									@*make alert for deleting collection*@
									<form method="post">
										<button asp-controller="Item" asp-action="Delete" asp-route-id="@Model.Coll.Id" asp-route-itemId="@item.Id" type="submit" class="btn btn-danger">Delete</button>
									</form>
								}
							</div>
						</td>
					</tr>
				}
			</tbody>
		</table>
	</div>
}

